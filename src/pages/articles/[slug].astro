---
import { render, type CollectionEntry } from "astro:content";
import TagChips from "../../components/TagChips.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { encodeTag, formatDate, getPublishedArticles } from "../../lib/articles";

interface Props {
  article: CollectionEntry<"articles">;
  previous?: CollectionEntry<"articles">;
  next?: CollectionEntry<"articles">;
}

export async function getStaticPaths() {
  const articles = await getPublishedArticles();
  return articles.map((article, index) => ({
    params: { slug: article.id },
    props: {
      article,
      previous: articles[index - 1],
      next: articles[index + 1],
    },
  }));
}

const { article, previous, next } = Astro.props as Props;
const { Content } = await render(article);

const canonical = new URL(
  `/articles/${article.id}/`,
  Astro.site ?? "https://natsu-b.github.io",
).toString();

const tagItems = article.data.tags.map((tag) => ({
  label: tag,
  href: `/tags/${encodeTag(tag)}/`,
}));
---

<BaseLayout
  title={`${article.data.title} | Articles | Natsu-B`}
  description={article.data.description}
  canonical={canonical}
>
  <article class="panel px-6 py-6 sm:px-8 sm:py-8">
    <header>
      <p class="text-sm text-slate-500">{formatDate(article.data.date)}</p>
      <h1 class="mt-2 text-2xl font-bold tracking-tight text-slate-800 sm:text-3xl">
        {article.data.title}
      </h1>
      <p class="mt-3 text-sm leading-7 text-slate-600 sm:text-base">{article.data.description}</p>
      {tagItems.length > 0 && <TagChips items={tagItems} className="mt-4" />}
    </header>

    <div class="article-content mt-7">
      <Content />
    </div>
  </article>

  <nav class="mt-6 grid gap-4 sm:grid-cols-2">
    {
      previous ? (
        <a href={`/articles/${previous.id}/`} class="panel panel-hover block p-5">
          <p class="text-xs uppercase tracking-wide text-slate-500">Newer</p>
          <p class="mt-2 text-sm font-semibold text-slate-700">{previous.data.title}</p>
        </a>
      ) : (
        <div class="panel panel-muted p-5 text-sm text-slate-500">これより新しい記事はありません。</div>
      )
    }

    {
      next ? (
        <a href={`/articles/${next.id}/`} class="panel panel-hover block p-5">
          <p class="text-xs uppercase tracking-wide text-slate-500">Older</p>
          <p class="mt-2 text-sm font-semibold text-slate-700">{next.data.title}</p>
        </a>
      ) : (
        <div class="panel panel-muted p-5 text-sm text-slate-500">これより古い記事はありません。</div>
      )
    }
  </nav>
</BaseLayout>

